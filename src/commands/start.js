const db = require('../db');
const { getLoginURL } = require('../services/esi');

const modulesList = require('../constants/modules');

module.exports = function startCommand(bot, msg) {
  const chatId = msg.chat.id;

  db.get('SELECT character_name FROM users WHERE telegram_id = ?', [chatId], (err, row) => {
    if (err) {
      console.error('[DB] ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:', err.message);
      return bot.sendMessage(chatId, 'ðŸš¨ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸.');
    }

    if (!row) {
      const loginUrl = getLoginURL(chatId);
      return bot.sendMessage(chatId, `ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð±Ð¾Ñ‚Ð¾Ð¼, ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐ¹ÑÑ Ñ‡ÐµÑ€ÐµÐ· EVE Online:`, {
        reply_markup: {
          inline_keyboard: [[{ text: 'ðŸ” ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ', url: loginUrl }]]
        }
      });
    }

    const keyboard = {
      inline_keyboard: modulesList.map(mod => [
        { text: mod.label, callback_data: `mod_${mod.id}` }
      ])
    };

    bot.sendMessage(chatId, `ðŸ‘‹ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ, ${row.character_name}!\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ:`, {
      reply_markup: keyboard
    });
  });
};
